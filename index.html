<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>boo</title>
		<link rel="stylesheet" href="style.css">
	</head>

	<body>
		<div id="curtain"></div>
		<div id="chars" class="container">
			<h1>ghost club blues</h1>
			<div id="character_selection">
				<button onclick="selectKid('kitty')"><p>kitty<br />
					<i>in progress</i></p></button>
				<button onclick="selectKid('pup')"><p>pup<br />
					<i>coming soon!</i></p></button>
				<button onclick="selectKid('bird')"><p>bird<br />
					<i>coming soon!</i></p></button>
				<button id="play_button" class="button_secondary" onclick="play()">play as&nbsp;<span id="name"></span></button>
			</div>
			<div id="character_info"></div>
		</div>
		<div id="game" class="container">
			<div id="scene_name"></div>
			<div id="dialogue"></div>
			<div id="menu"></div><div id="menu_tooltip"></div>
		</div>
	</body>

	<script src="dialog.js"></script>
	<script src="icons.js"></script>
	<script src="objects.js"></script>
	<script src="scenes.js"></script>
	<script>
		var kids = {
			current: null,
			kitty: {
				menu: [ICON.inventory, ICON.listen],
				inventory: [OBJECT.kGLOWSTICK, OBJECT.kGLOWSTICK, OBJECT.kBOMB, OBJECT.kSPYPEN, OBJECT.kWATCH],
				bgcolor: "#fff49d",
				strongcolor: "#ffe24f",
				scene: SCENE.oasis
			},
			pup: {
				menu: [ICON.inventory, ICON.fight],
				inventory: [OBJECT.pHAMMER, OBJECT.kGLOWSTICK, OBJECT.iICECREAMSANDWICH],
				bgcolor: "#9dceff",
				strongcolor: "#4fcdff",
				scene: SCENE.oasis
			},
			bird: {
				menu: [ICON.inventory, ICON.handbook],
				inventory: [OBJECT.bHANDBOOK, OBJECT.iICECREAMSANDWICH, OBJECT.iICECREAMSANDWICH, OBJECT.iICECREAMSANDWICH, OBJECT.iICECREAMSANDWICH, OBJECT.bQUILL, OBJECT.bPEN, OBJECT.bPEN],
				bgcolor: "#ff9db7",
				strongcolor: "#ff4f90",
				scene: SCENE.oasis
			}
		};
		kids.kitty.info = `<mark>kitty</mark>
					<br /><br />
					the ghost whisperer<br /><br />
					age: 11<br /><br />`;
		kids.pup.info = `<mark>pup</mark>
					<br /><br />
					<a onclick="t(DIALOGUE.exghosthunter)">ex ghost hunter</a><br /><br />
					age: 13<br /><br />`;
		kids.bird.info = `<mark>bird</mark>
					<br /><br />
					self-proclaimed ghost scholar<br /><br />
					age: 12<br /><br />`;

		var char_info = document.getElementById("character_info");
		var game = document.getElementById("game");
		var menu = document.getElementById("menu");
		var menu_tooltip = document.getElementById("menu_tooltip");
		var root = document.documentElement;

		window.oncontextmenu = function() {
			return false
		};

		function selectKid(name) {
			kids.current = name;
			char_info.style.display = "inline-block";
			char_info.className = "info_enter";
			char_info.innerHTML = kids[name].info+parseList("inventory", kids[kids.current].inventory);

			document.getElementById("play_button").style.display = "flex";
			document.getElementById("play_button").className = "button_secondary flicker-in";
			root.style.setProperty("--highlight", kids[name].bgcolor);
			root.style.setProperty("--highlight-dark", kids[name].strongcolor);

			cleart();

			document.getElementById("name").textContent = name;
		}

		function play() {
			transition(kids[kids.current].bgcolor, game);
			let menu = kids[kids.current].menu;
			for (let i=0; i<menu.length; i++) {
				printMenuIcon(kids[kids.current].menu[i])
			}
			setScene();
			document.querySelector("title").textContent = kids.current;
			animate();
		}

		var current_container = document.getElementById("chars");
		function transition(color, container) {
			let curtain = document.getElementById("curtain");
			curtain.style.background = color;
			curtain.className = "curtain_wipe";
			setTimeout(function() {
				current_container.style.display = "none";
				document.body.style.background = color;
				curtain.className = "";
				container.style.display = "block";
				current_container = container;
			}, 2000);
		}

		var dialogue = document.getElementById("dialogue");
		var scene_name = document.getElementById("scene_name");
		function setScene(keepTbox) {
			//this is so broken_tooltips doesnt become a billion elements long
			broken_tooltips = [];

			keepTbox = keepTbox || false;
			let savedt = null;
			if (keepTbox && game.getElementsByClassName("tbox").length > 0) {
				savedt = document.querySelector(".tbox");
			}

			let scene = kids[kids.current].scene;
			scene_name.innerHTML = scene.sceneobject.name;

			let scenecontent = setObject(scene.sceneobject, "scene")+" ";
			for (let i=0; i<scene.objects.length; i++) {
				let line = setObject(scene.objects[i], "item", i);
				scenecontent += line + " ";
			}

			let sceneexits = "";
			for (let i=0; i<scene.exits.length; i++) {
				sceneexits += setObject(scene.exits[i], "exit");
			}

			dialogue.innerHTML = scenecontent + "<br /><br />" + sceneexits;

			if (savedt) { dialogue.appendChild(savedt) }

			if (!scene.visited) { scene.visited = true }

			function setObject(obj, type, index) {
				let l = obj.line;

				switch(type) {
					case "scene":
						if (kids.current in obj) {
							l = l.replace("]", "CLOSEDBRACKETCHAR");
							l = l.replace("[", "OPENBRACKETCHAR");

							let string = obj[kids.current];
							let extra = "";
							if (Array.isArray(obj[kids.current])) {
								let index = obj[kids.current][0];
								string = obj[kids.current][index];
								if (index < obj[kids.current].length-1) {
									obj[kids.current][0]++;
									extra = ";setScene(true)";
								}
								if (string=="") {
									l = l.replace(`OPENBRACKETCHAR`, ``);
									l = l.replace(`CLOSEDBRACKETCHAR`, ``);
									break;
								}
							}
							if (string.includes("<")) {
								let i = broken_tooltips.length;
								broken_tooltips.push(string);
								l = l.replace(`CLOSEDBRACKETCHAR`, `</a>`);
								l = l.replace(`OPENBRACKETCHAR`, `<a onclick="t(broken_tooltips[`+i+`])`+extra+`">`);
							} else {
								l = l.replace(`OPENBRACKETCHAR`, `<a onclick="t('`+string+`')`+extra+`">`);
								l = l.replace(`CLOSEDBRACKETCHAR`, `</a>`);
							}
						} else {
							l = l.replace(`[`, ``);
							l = l.replace(`]`, ``);
						}
						break;
					case "item":
						l = l.replace(`[`, `<a onclick="pickUp(`+index+`)">`);
						l = l.replace(`]`, `</a>`);
						break;
					case "exit":
						l = l.replace(`]`, `</mark>`);
						l = l.replace("[", `<mark onclick="kids[kids.current].scene=SCENE['`+obj.destination+`'];setScene()">`);
						break;
				}

				return l
			}
		}

		function pickUp(index) {
			kids[kids.current].inventory.push(kids[kids.current].scene.objects[index]);
			kids[kids.current].scene.objects.splice(index, 1);
			setScene();
			if (kids[kids.current].inventory.length==0) {
				t("inventory: empty");
				return
			}
			t(parseList("inventory", kids[kids.current].inventory)+"<br /><br /><i>right click items to unload them</i>");
		}

		function dropItem(index) {
			if (current_container != game) { return }
			kids[kids.current].scene.objects.push(kids[kids.current].inventory[index]);
			kids[kids.current].inventory.splice(index, 1);
			setScene();
			if (kids[kids.current].inventory.length==0) {
				t("inventory: empty");
				return
			}
			t(parseList("inventory", kids[kids.current].inventory)+"<br /><br /><i>right click items to unload them</i>");
		}

		function printMenuIcon(icon) {
			var button = document.createElement("button");
			button.textContent = icon.name;
			let tooltip = icon.tooltip;
			button.onmouseover = function() {
				menu_tooltip.textContent = tooltip;
			}
			button.onmouseout = function() {
				menu_tooltip.textContent = "";
			}
			if ('function' in icon) {
				button.onclick = icon.function;
			}
			menu.appendChild(button);
		}

		function t(tooltip) {
			let tboxes = current_container.getElementsByClassName("tbox");
			if (tboxes.length > 0) {
				tboxes[0].innerHTML = tooltip;
			} else {
				let tbox = document.createElement("div");
				tbox.className = "tbox";
				tbox.innerHTML = tooltip;
				if (current_container==game) {
					dialogue.appendChild(tbox);
				} else {
					current_container.appendChild(tbox);
				}
				tbox.onclick = function(e){ this.remove() };
			}

			event.cancelBubble = true;
		}

		function cleart() {
			if (current_container.getElementsByClassName("tbox").length > 0) {
				current_container.removeChild(document.querySelector(".tbox"))
			}
		}

		var counter = 0;
		function animate() {
			requestAnimationFrame(animate);

			counter++;
		}
	</script>
	<script src="whispers.js"></script>

</html>