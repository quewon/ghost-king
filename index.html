<!DOCTYPE html>
<html>

	<head>
		<title>GHOST KING</title>
		<link rel="stylesheet" href="style.css">
	</head>

	<body>
		<div id="curtain"></div>
		<div id="chars" class="container">
			<h1>GHOST KING</h1>
			<div id="character_selection">
				<button onclick="selectKid('kitty')">kitty</button>
				<!-- <button onclick="selectKid('pup')">pup</button>
				<button onclick="selectKid('bird')">bird</button> -->
				<button id="play_button" class="button_secondary" onclick="play()">play as&nbsp;<span id="name"></span></button>
			</div>
			<div id="character_info"></div>
		</div>
		<div id="game" class="container">
			<span id="dialogue"></span>
		</div>
	</body>

	<script src="dialog.js"></script>
	<script>
		var kid;
		var kid_colors = {
			kitty: "#FEEE99",
			pup: "#99FEEE",
			bird: "#EE99FE"
		}

		var char_info = document.getElementById("character_info");
		var game = document.getElementById("game");
		var root = document.documentElement;

		window.oncontextmenu = function() {
			return false
		};

		function selectKid(name) {
			kid = name;
			char_info.style.display = "inline-block";
			char_info.className = "info_enter";
			char_info.innerHTML = kid_info[name];

			document.getElementById("play_button").style.display = "flex";
			document.getElementById("play_button").className = "button_secondary flicker-in";
			root.style.setProperty("--highlight", kid_colors[name]);

			cleart();

			document.getElementById("name").textContent = name;
		}

		var stopped = false;
		function play() {
			transition(kid_colors[kid], game);
			print(kid, 1, window.event);
			setTimeout(function() {
				document.onclick = function(e) {
					if (stopped) { return }
					print(kid, 1, e)
				};
				document.oncontextmenu = function(e) {
					print(kid, -1, e);
					return false
				};
				document.addEventListener("keyup", function(e) {
					let k = e.keyCode;
					if (k==32 || k==39) {
						if (stopped) { return }
						print(kid, 1, e)
					} else if (k==37) {
						print(kid, -1, e)
					}
				})
			}, 4000);
			animate();
		}

		var current_container = document.getElementById("chars");
		function transition(color, container) {
			let curtain = document.getElementById("curtain");
			curtain.style.background = color;
			curtain.className = "curtain_wipe";
			setTimeout(function() {
				current_container.style.display = "none";
				document.body.style.background = color;
				curtain.className = "";
				container.style.display = "block";
				current_container = container;
			}, 2000);
		}

		var dialogue = document.getElementById("dialogue");
		function print(kid, step, e) {
			while (game.childNodes.length > 2) {
				game.removeChild(game.lastChild)
			}

			if (DIALOG[kid][0]+step > 0) {
				DIALOG[kid][0] += step;
			}
			let i = DIALOG[kid][0];
			let d = DIALOG[kid][i];
			d = d.replace("<<", "<span class='caret'><</span>");
			if (d.includes('[[stop]]')) {
				console.log(d);
				d = d.replace("[[stop]]", "");
				togglePrinting();
			} else if (stopped) {
				togglePrinting();
			}
			if (d.includes('[[t: ')) {
				d = d.replace("[[t: ", `<a onclick="t('`);
				d = d.replace("]]", `')">`)
				d = d.replace("[[/t]]", `</a>`);
			}
			dialogue.innerHTML = d;
		}

		function togglePrinting() {
			stopped = !stopped;
		}

		function t(label) {
			let tboxes = current_container.getElementsByClassName("tbox");
			if (tboxes.length > 0) {
				tboxes[0].innerHTML = TOOLTIP[label];
			} else {
				let tbox = document.createElement("div");
				tbox.className = "tbox";
				tbox.innerHTML = TOOLTIP[label];
				current_container.appendChild(tbox);
			}
			event.cancelBubble = true;
		}

		function cleart() {
			if (current_container.getElementsByClassName("tbox").length > 0) {
				current_container.removeChild(document.querySelector(".tbox"))
			}
		}

		var counter = 0;
		function animate() {
			requestAnimationFrame(animate);

			counter++;
		}
	</script>
	<script src="whispers.js"></script>

</html>